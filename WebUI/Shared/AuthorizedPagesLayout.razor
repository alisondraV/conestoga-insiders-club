@inherits LayoutComponentBase
@attribute [Authorize]
@using ConestogaInsidersClub.Data.Models;
@using ConestogaInsidersClub.Data.DataAccess;
@using ConestogaInsidersClub.Pages.ViewModels;

@inject IUserService userService;

<div class="page">
    <div class="sidebar">
        <NavMenu />
    </div>

    <div class="main">
        <div class="top-row px-4 auth">
            <LoginDisplay />
        </div>

        <div class="content px-4">
            <AuthorizeView>
                <Authorized>
                    @if (user == null)
                    {
                        <h3>Loading...</h3>
                    }
                    else
                    {
                        <CascadingValue Value="@user" Name="user">
                            <CascadingValue Value="@userViewModel" Name="userViewModel">
                                @Body
                            </CascadingValue>
                        </CascadingValue>
                    }
                </Authorized>
                <NotAuthorized>
                    <h3 id="Unauthorized_View">
                        You can't view this page unless you're authorized
                    </h3>
                </NotAuthorized>
            </AuthorizeView>
        </div>
    </div>
</div>

@code {
    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationState { get; set; }
    private AuthenticationState authenticationState;
    private ApplicationUser user;
    private UserVM userViewModel;

    protected override async Task OnInitializedAsync()
    {
        authenticationState = await AuthenticationState;
        if (authenticationState.User.Identity.IsAuthenticated)
        {
            user = await userService.GetUserWithRelatedData(authenticationState.User.Identity.Name);
            userViewModel = UserVM.ToViewModel(user);
        }
    }
}