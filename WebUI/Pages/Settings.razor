@page "/settings"
@using ConestogaInsidersClub.Data.Models;
@using ConestogaInsidersClub.Data.DataAccess;
@using ConestogaInsidersClub.Pages.ViewModels;

@inject IPreferenceService preferenceService;
@inject IGameService gameService;

<h1>Settings</h1>
@if (authenticationState == null)
{
    <h3>Loading...</h3>
}
else if (editMode != true)
{
    <h3>Preferences</h3>
    <table>
        <tr>
            <td width="350px"><b>Your favourite genre:</b></td>
            <td><span id="Genre">@(preference.Genre.Name ?? "*Not set yet*")</span></td>
        </tr>
        <tr>
            <td width="350px"><b>Your favourite platform:</b></td>
            <td><span id="Platform">@(preference.Platform ?? "*Not set yet*")</span></td>
        </tr>
        <tr>
            <td width="350px"><b>Your favourite game:</b></td>
            <td><span id="Favourite_Game">@(preference.FavouriteGame?.Name ?? "*Not set yet*")</span></td>
        </tr>
        <tr>
            <td width="350px"><b>Recieve promotional emails</b></td>
            <td><input disabled type="checkbox" checked="@(preference.ReceivePromotionalEmails ?? false)" id="Recieve_Promotions" /></td>
        </tr>
    </table>
    <br />
    <button @onclick="@FlipEditMode">Edit</button>
}
else
{
    <br />
    <EditForm Model="@preferenceViewModel" OnValidSubmit="@HandleValidSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <h3>Edit Preferences</h3>
        <br />
        <p>
            <label>
                Your favourite genre:
                <InputText id="Genre_Edit" @bind-Value="preferenceViewModel.Genre" />
            </label>
        </p>
        <p>
            <label>
                Your favourite platform:
                <InputText id="Platform_Edit" @bind-Value="preferenceViewModel.Platform" />
            </label>
        </p>
        <p>
            <label>
                Do you wish to recieve promotions?
                <InputCheckbox id="Recieve_Promotions_Edit" @bind-Value="preferenceViewModel.ReceivePromotionalEmails" />
            </label>
        </p>
        <p>
            <label>
                Your favourite game:
                <InputSelect id="Favourite_Game_Edit" @bind-Value="preferenceViewModel.FavouriteGame">
                    <option value="null">None</option>
                    @foreach (var game in games)
                    {
                        <option value="@game">@game.Name</option>
                    }
                </InputSelect>
            </label>
        </p>

        <button type="submit">Save</button>
    </EditForm>
}

@code {
    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationState { get; set; }
    private AuthenticationState authenticationState;
    private Preference preference;
    private List<Game> games;
    private PreferenceVM preferenceViewModel = new PreferenceVM();
    private bool editMode = false;

    protected override async Task OnInitializedAsync()
    {
        authenticationState = await AuthenticationState;
        preference = await preferenceService.GetPreference(authenticationState.User.Identity.Name);
        games = await gameService.GetGames();

        preferenceViewModel = PreferenceVM.ToViewModel(preference);
    }

    private async void HandleValidSubmit()
    {
        Preference updatedPreference = PreferenceVM.ToModel(preference, preferenceViewModel);
        updatedPreference.UserId = preference.UserId;
        await preferenceService.UpdatePreference(updatedPreference);
        FlipEditMode();
    }

    private void FlipEditMode()
    {
        editMode = !editMode;
    }
}
