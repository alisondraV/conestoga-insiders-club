@page "/settings"
@using ConestogaInsidersClub.Data.Models;
@using ConestogaInsidersClub.Data.DataAccess;
@using ConestogaInsidersClub.Pages.ViewModels;

@inject IPreferenceService preferenceService;
@inject IGameService gameService;
@inject IGameGenreService gameGenreService;
@inject IUserService userService;

<h1>Settings</h1>
<br />

@if (user == null)
{
    <h3>Loading...</h3>
}
else
{
    if (editPreferenceMode != true)
    {
        <h4>Preferences</h4>
        <table>
            <tr>
                <td><b>Your favourite genre:</b></td>
                <td><span id="Genre">@(preference.GenreName ?? "*Not set yet*")</span></td>
            </tr>
            <tr>
                <td><b>Your favourite platform:</b></td>
                <td><span id="Platform">@(preference.Platform ?? "*Not set yet*")</span></td>
            </tr>
            <tr>
                <td><b>Your favourite game:</b></td>
                <td><span id="Favourite_Game">@(preference.FavouriteGame?.Name ?? "*Not set yet*")</span></td>
            </tr>
            <tr>
                <td><b>Recieve promotional email:</b></td>
                <td><span id="Recieve_Promotions">@(preference.ReceivePromotionalEmails ?? false ? "Yes" : "No")</span></td>
            </tr>
        </table>
        <button @onclick="@FlipEditPreferenceMode">Edit</button>
    }
    else
    {
        <EditForm Model="@preferenceViewModel" OnValidSubmit="@HandlePreferenceSubmit">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <h3>Edit Preferences</h3>
            <table>
                <tr>
                    <td>Your favourite genre:</td>
                    <td>
                        <InputSelect id="Genre_Edit" @bind-Value="preferenceViewModel.GenreName">
                            <option value="">None</option>
                            @foreach (var genre in gameGenres)
                            {
                                <option value="@genre.Name">@genre.Name</option>
                            }
                        </InputSelect>
                    </td>
                </tr>
                <tr>
                    <td>Your favourite platform:</td>
                    <td><InputText id="Platform_Edit" @bind-Value="preferenceViewModel.Platform" /></td>
                </tr>
                <tr>
                    <td>Your favourite game:</td>
                    <td>
                        <InputSelect id="Favourite_Game_Edit" @bind-Value="preferenceViewModel.FavouriteGameId">
                            <option value="">None</option>
                            @foreach (var game in games)
                            {
                                <option value="@game.GameId">@game.Name</option>
                            }
                        </InputSelect>
                    </td>
                </tr>
                <tr>
                    <td>Do you wish to recieve promotions?</td>
                    <td><InputCheckbox id="Recieve_Promotions_Edit" @bind-Value="preferenceViewModel.ReceivePromotionalEmails" /></td>
                </tr>
            </table>
            <button type="submit">Save</button>
        </EditForm>
    }

    <br />
    <br />

    if (editAddressMode != true)
    {
        <h4>Mailing Address</h4>
        <table>
            <tr>
                <td><b>Address:</b></td>
                <td><span id="Address1">@(user.MailingAddress.Address1 ?? "Not set yet")</span></td>
            </tr>
            <tr>
                <td><b>City:</b></td>
                <td><span id="City">@(user.MailingAddress.City ?? "*Not set yet*")</span></td>
            </tr>
            <tr>
                <td><b>Province:</b></td>
                <td><span id="Province">@(user.MailingAddress.Province ?? "*Not set yet*")</span></td>
            </tr>
            <tr>
                <td><b>Country:</b></td>
                <td><span id="Country">@(user.MailingAddress.Country ?? "*Not set yet*")</span></td>
            </tr>
            <tr>
                <td><b>Postal Code:</b></td>
                <td><span id="Postal_Code">@(user.MailingAddress.PostalCode ?? "*Not set yet*")</span></td>
            </tr>
        </table>
        <button @onclick="@FlipEditAddressMode">Edit</button>
        <br />
    }
    else
    {
        <EditForm Model="@userViewModel" OnValidSubmit="@HandleAddressSubmit">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <h3>Edit Address</h3>
            <table>
                <tr>
                    <td>Address:</td>
                    <td><InputText id="Address1_Edit" @bind-Value="userViewModel.MailingAddress.Address1" /></td>
                </tr>
                <tr>
                    <td>City:</td>
                    <td><InputText id="City_Edit" @bind-Value="userViewModel.MailingAddress.City" /></td>
                </tr>
                <tr>
                    <td>Province:</td>
                    <td><InputText id="Province_Edit" @bind-Value="userViewModel.MailingAddress.Province" /></td>
                </tr>
                <tr>
                    <td>Country:</td>
                    <td><InputText id="Country_Edit" @bind-Value="userViewModel.MailingAddress.Country" /></td>
                </tr>
                <tr>
                    <td>Postal Code:</td>
                    <td><InputText id="Postal_Code_Edit" @bind-Value="userViewModel.MailingAddress.PostalCode" /></td>
                </tr>
            </table>
            <br />
            <button type="submit">Save</button>
        </EditForm>
    }
}

@code {
    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationState { get; set; }
    private AuthenticationState authenticationState;
    private ApplicationUser user;
    private Preference preference;
    private List<Game> games;
    private List<GameGenre> gameGenres;
    private UserVM userViewModel = new UserVM();
    private PreferenceVM preferenceViewModel = new PreferenceVM();
    private bool editPreferenceMode = false;
    private bool editAddressMode = false;

    protected override async Task OnInitializedAsync()
    {
        authenticationState = await AuthenticationState;
        user = await userService.GetUser(authenticationState.User.Identity.Name);
        preference = await preferenceService.GetPreference(user.UserName);
        games = await gameService.GetGames();
        gameGenres = await gameGenreService.GetGameGenres();

        userViewModel = UserVM.ToViewModel(user);
        preferenceViewModel = PreferenceVM.ToViewModel(preference);
    }

    private async void HandlePreferenceSubmit()
    {
        Preference updatedPreference = PreferenceVM.ToModel(preference, preferenceViewModel);
        await preferenceService.UpdatePreference(updatedPreference);
        FlipEditPreferenceMode();
        StateHasChanged();
    }

    private async void HandleAddressSubmit()
    {
        ApplicationUser updatedUser = UserVM.ToModel(user, userViewModel);
        await userService.UpdateUser(updatedUser);
        FlipEditAddressMode();
        StateHasChanged();
    }

    private void FlipEditPreferenceMode()
    {
        editPreferenceMode = !editPreferenceMode;
    }

    private void FlipEditAddressMode()
    {
        editAddressMode = !editAddressMode;
    }
}
