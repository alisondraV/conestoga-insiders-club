@page "/credit-card"
@using ConestogaInsidersClub.Data.Models;
@using ConestogaInsidersClub.Data.DataAccess;
@using ConestogaInsidersClub.Pages.ViewModels;

@inject IUserService userService;

<h2>Credit Cards</h2>
<br />

@if (editMode != true)
{
    if (cards.Count != 0)
    {
        <table>
            @foreach (var card in cards)
            {
                <tr>
                    <td><b>Card Number :</b></td>
                    <td><span id="Card_Number">@card.CardNumber</span></td>
                </tr>
                <tr>
                    <td><b>Expiration Date:</b></td>
                    <td><span id="Expiration_Date">@card.ExpirationMonth/@card.ExpirationYear</span></td>
                </tr>
                <tr>
                    <td>
                        <button class="btn-danger rounded btn-delete" @onclick="@(() => DeleteCard(card.CardId))">Delete</button>
                    </td>
                </tr>
                <tr />
            }
        </table>
    }
    else
    {
        <p>You don't have any credit cards recorded, do you want to add one?</p>
    }
    <button class="btn-primary rounded mt-2" @onclick="@AddNewCard">Add a credit card</button>
    }
else
{
    <EditForm Model="@cardsVM" OnValidSubmit="@HandleCreditCardSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <h3>Edit Credit Cards</h3>
        <br />
        <table>
            @*@foreach (var card in cardsVMs)
            {*@
                <tr>
                    <td><b>Enter Card Number :</b></td>
                    <td><InputText id="Card_Number_Edit" @bind-Value="cardsVM.CardNumber" /></td>
                </tr>
                <tr>
                    <td><b>Expiration Month:</b></td>
                    <td><InputNumber id="Card_Month_Edit" @bind-Value="cardsVM.ExpirationMonth" /></td>
                </tr>
                <tr>
                    <td><b>Expiration Year:</b></td>
                    <td><InputNumber id="Card_Year_Edit" @bind-Value="cardsVM.ExpirationYear" /></td>
                </tr>
                <tr />
            @*}*@
        </table>
        <button class="btn-info rounded mt-2" type="submit">Save</button>
    </EditForm>
}

@code {
    [CascadingParameter(Name = "user")]
    protected ApplicationUser user { get; set; }
    [CascadingParameter(Name = "userViewModel")]
    private UserVM userViewModel { get; set; }

    private ICollection<Card> cards;
    private CreditCardVM cardsVM;
    private bool editMode = false;

    protected override void OnInitialized()
    {
        cards = user.Cards;
        cardsVM = new CreditCardVM(cards.Count == 0 ? new Card() : cards.First());
    }

    private async void HandleCreditCardSubmit()
    {
        user.Cards.Add(cardsVM.ToModel());
        await userService.UpdateUser(user);
        FlipEditMode();
        StateHasChanged();
    }

    private void AddNewCard()
    {
        cardsVM = new CreditCardVM(new Card());
        FlipEditMode();
    }

    private async void DeleteCard(int cardId)
    {
        await userService.DeleteCard(user.Id, cardId);
        cards = user.Cards;
        StateHasChanged();
    }

    private void FlipEditMode()
    {
        editMode = !editMode;
    }
}
