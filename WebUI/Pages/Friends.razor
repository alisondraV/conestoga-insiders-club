@page "/friends"
@using ConestogaInsidersClub.Data.Models;
@using ConestogaInsidersClub.Data.DataAccess;

@inject IUserService userService;

<h1>Friends</h1>

@if (currentUser == null)
{
    <h3>Loading...</h3>
}
else
{
    <div>
        <button class="tab alert @(friendsTab ? "alert-primary" : "")" @onclick="() => SwitchToFriendsTab(true)">Your Friends</button>
        <button class="tab alert @(friendsTab ? "" : "alert-primary")" @onclick="() => SwitchToFriendsTab(false)">Add a Friend</button>
    </div>

    @if (friendsTab)
    {
        if (friends.Count == 0)
        {
            <h4>You have no friends yet. Go to the "Add a Friend" tab to find new friends!</h4>
        }
        else
        {
            @foreach (var friend in friends)
            {
                <div>
                    <p>@friend.UserName</p>
                </div>
            }
        }
    }
    else
    {
        if (possibleFriends.Count == 0)
        {
            <h4>There are no available friends at the moment :(</h4>
        }
        else
        {
            @foreach (var possibleFriend in possibleFriends)
            {
                <div class="col-3 border border-secondary rounded mb-2 p-3 bg-light d-flex-column justify-content-center align-items-center">
                    <span><b>@possibleFriend.UserName</b></span>
                    <br />
                    <span>@possibleFriend.FirstName @possibleFriend.LastName</span>
                    <br />
                    <button @onclick="() => AddFriend(possibleFriend.Id)">Add a friend</button>
                </div>
            }
        }
    }
}

@code {
    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationState { get; set; }
    private AuthenticationState authenticationState;
    private ApplicationUser currentUser;
    private List<ApplicationUser> friends;
    private List<ApplicationUser> possibleFriends = new List<ApplicationUser> { };
    private bool friendsTab = true;

    protected override async Task OnInitializedAsync()
    {
        authenticationState = await AuthenticationState;
        currentUser = await userService.GetUser(authenticationState.User.Identity.Name);
        friends = await userService.GetFriends(currentUser);

        var users = await userService.GetUsers();
        var friendsIds = friends.Select(u => u.Id).ToList();
        foreach (var user in users)
        {
            if (user.Id != currentUser.Id && !friendsIds.Contains(user.Id))
            {
                possibleFriends.Add(user);
            }
        }
    }

    private void SwitchToFriendsTab(bool isFriendsTab)
    {
        friendsTab = isFriendsTab;
    }

    private async void AddFriend(string userId)
    {
        await userService.CreateFriendship(currentUser.Id, userId);
        StateHasChanged();
    }
}
